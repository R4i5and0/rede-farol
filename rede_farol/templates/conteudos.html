{% extends "base.html" %}

{% block title %}Conteúdos - Rede Farol{% endblock %}

{% block styles %}
{{ super() }}
<style>

    /* Barra de Filtros (Categorias) */
    .filter-bar .btn {
        background-color: rgba(142, 45, 226, 0.2);
        color: #ffffff;
        border: 1px solid rgba(142, 45, 226, 0.5);
        border-radius: 20px;
        padding: 6px 15px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-transform: uppercase; /* Deixar os botões de categoria em uppercase */
        font-size: 0.85rem;
    }

    .filter-bar .btn.active,
    .filter-bar .btn:hover {
        background: linear-gradient(90deg, #8e2de2, #4a00e0);
        border-color: #ffffff;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(142, 45, 226, 0.4);
    }
    
    /* Card de Conteúdo */
    .conteudo-card {
    background: rgba(30, 30, 50, 0.85) !important;
    border: 1px solid rgba(142, 45, 226, 0.2) !important;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
   /* height: 360px;  Altura total do card */
}

    .conteudo-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(255, 193, 7, 0.4); 
        border-color: #ffc107 !important;
    }
.conteudo-card .card-img-top {
    height: 140px; /* Reduzindo a altura da imagem */
    object-fit: cover;
    opacity: 0.8;
    transition: opacity 0.3s ease;
    border-bottom: 1px solid rgba(142, 45, 226, 0.3);
}

   .conteudo-card .card-img-top {
    height: 180px; /* Aumentei de 150px para 180px */
    object-fit: cover;
    opacity: 0.8;
    transition: opacity 0.3s ease;
    border-bottom: 1px solid rgba(142, 45, 226, 0.3); /* Linha sutil abaixo da imagem */
}

    
.conteudo-card .card-body {
    padding: 8px 12px; /* Mais compacto */
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}
.conteudo-card .card-title {
    color: #e0e0ff;
    font-weight: 700;
    font-size: 1rem; /* Um pouco menor para caber mais */
    margin-bottom: 4px; /* Menos espaço abaixo do título */
    line-height: 1.3;
}

.conteudo-card .card-text {
    color: #b0b0c0;
    font-size: 0.82rem; /* Um pouco menor para a descrição */
    margin-bottom: 8px; /* Espaço abaixo da descrição */
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 4; /* Limita a 4 linhas para uma descrição mais completa, mas controlada */
    -webkit-box-orient: vertical;
}
    /* Badges de Tipo (Video/PDF) */
    .badge-type {
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        padding: 5px 8px;
        border-radius: 5px;
        display: inline-flex;
        align-items: center;
        text-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .badge-info { background-color: rgba(0, 150, 255, 0.8) !important; }
    .badge-danger { background-color: rgba(255, 70, 70, 0.8) !important; }
    .badge-warning { background-color: rgba(255, 193, 7, 0.8) !important; }


    /* Botões de Ação no Card */
.conteudo-card .btn {
    font-size: 0.85rem;  /* Aumentado */
    padding: 6px 12px; /* Aumentado */
    border-radius: 4px;
    font-weight: 600;
    transition: all 0.2s ease;
    border: 1px solid transparent;
    color: #e0e0e0;
    text-transform: uppercase;
    /* min-width: 50px; */ /* Pode remover isso */
    flex-grow: 1; /* Adicionado para esticarem */
    text-align: center; /* Garante centralização do texto */
}


/* Espaçamento entre os botões */
.conteudo-card .d-flex.gap-2 {
    gap: 8px; /* Aumentado (era 4px) */
    width: 100%; /* Adicionado para ocupar a largura toda */
}
    .btn-like {
        background-color: rgba(255, 107, 107, 0.2);
        color: #ff6b6b;
    }
    .btn-like:hover {
        background-color: rgba(255, 107, 107, 0.4);
        border-color: #ff6b6b;
    }

    .btn-view {
        background-color: rgba(142, 45, 226, 0.2);
    }
    .btn-view:hover {
        background-color: rgba(142, 45, 226, 0.4);
        border-color: #8e2de2;
    }

    .btn-rate {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }
    .btn-rate:hover {
        background-color: rgba(255, 193, 7, 0.4);
        border-color: #ffc107;
    }

    /* Coluna Lateral (Mais Populares) - Estilo Diferenciado */
.card-sidebar {
    background: rgba(80, 30, 180, 0.9); /* roxo profundo */
    border: 2px solid rgba(142, 45, 226, 0.5);
    border-radius: 16px;
    overflow: hidden; /* Para não ter scroll externo */
    padding: 0;
    box-shadow: 0 8px 25px rgba(142, 45, 226, 0.4);
    max-height: 500px; /* Altura máxima — ajuste conforme necessário */
    display: flex;
    flex-direction: column;
}

.card-sidebar .card-header {
    background: linear-gradient(90deg, #8e2de2, #4a00e0);
    color: #ffffff;
    padding: 1rem 1.5rem;
    border-bottom: none;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-weight: 700;
    font-size: 1.25rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}

.card-sidebar .card-body {
    padding: 1rem;
    flex-grow: 1;
    overflow-y: auto; /* Scroll interno dentro da caixa */
    max-height: 400px; /* Limita altura do conteúdo interno */
}

.popular-list .list-group-item {
    background-color: transparent !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
    transition: background-color 0.2s ease;
    padding: 0.75rem 1rem;
}

.popular-list .list-group-item:hover {
    background-color: rgba(142, 45, 226, 0.1) !important;
}
    /* Classe de utilidade para o degradê no contador de likes */
    .badge-likes {
        background: linear-gradient(45deg, #ff6b6b, #ffc107) !important; /* Degradê de vermelho para amarelo */
        color: white;
        text-shadow: 0 0 5px rgba(0,0,0,0.5);
    }

    /* Ajustes para o modal */
    .modal-content-custom {
        background: linear-gradient(135deg, rgba(30, 30, 50, 0.95), rgba(15, 15, 30, 0.95));
        border: 2px solid rgba(142, 45, 226, 0.5);
        border-radius: 15px;
        box-shadow: 0 0 30px rgba(142, 45, 226, 0.4);
    }

    .modal-header-custom {
        background: linear-gradient(90deg, #8e2de2, #4a00e0);
        border-bottom: none;
        border-top-left-radius: 13px;
        border-top-right-radius: 13px;
    }

    .modal-body-custom {
        color: #e0e0e0;
    }

    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%); /* Torna o X branco */
    }

    /* Responsividade: Coluna Popular em tela pequena */
    @media (max-width: 991.98px) {
        .order-lg-2 {
            order: 2; /* Move a sidebar para baixo em telas pequenas */
        }
        .order-lg-1 {
            order: 1; /* Move o conteúdo principal para cima em telas pequenas */
        }
        
    }

</style>
{% endblock %}

{% block content %}
<div class="content-wrap container-fluid" >
    <div class="hero-content mx-auto text-center mb-4">
      <h1 class="neon-float-title">Nossa Curadoria de Conteúdos</h1>
        <div class="filter-bar">
            <a href="{{ url_for('listar_conteudos') }}" class="btn {% if not request.args.get('categoria') %}active{% endif %}">Ver Todos</a>
            
            {% for categoria in todas_as_categorias %}
                <a href="{{ url_for('listar_conteudos', categoria=categoria.id_categoria) }}" 
                    class="btn {% if request.args.get('categoria') == categoria.id_categoria|string %}active{% endif %}">
                    {{ categoria.nome_categoria }}
                </a>
            {% endfor %}
        </div>
        
    </div>

    <div class="row g-4">
    {# Coluna Principal: Lista de Conteúdos. Ocupa 8 colunas em tela grande (lg) #}
    <div class="col-lg-8 order-lg-1">
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-2 g-4" id="conteudo-grid"> 
            {% for conteudo in conteudos %}
            <div class="col">
                <div class="card h-100 conteudo-card border-0 shadow-sm">
                    <img src="{{ url_for('static', filename='uploads/' + conteudo.thumbnail) if conteudo.thumbnail else url_for('static', filename='img/farol.jpg') }}" 
                         class="card-img-top" alt="{{ conteudo.titulo }}" loading="lazy">

                    <div class="card-body d-flex flex-column pt-3">
                        <div class="d-flex align-items-center mb-2">
                            {% set tipo_norm = conteudo.tipo|lower|replace('á', 'a')|replace('é', 'e')|replace('í', 'i')|replace('ó', 'o')|replace('ú', 'u')|replace('ã', 'a')|replace('õ', 'o')|replace('ç', 'c')|replace(' ', '') %}
                            <span class="badge badge-type 
                                 {{ 'badge-info' if 'video' in tipo_norm else 'badge-danger' if 'pdf' in tipo_norm else 'badge-warning' }} 
                                 shadow-sm">
                                <i class="
                                    {% if 'video' in tipo_norm %}
                                        fas fa-video
                                    {% elif 'pdf' in tipo_norm %}
                                        fas fa-file-pdf
                                    {% elif 'audio' in tipo_norm %}
                                        fas fa-volume-up
                                    {% else %}
                                        fas fa-link
                                    {% endif %}
                                    me-1">
                                </i>
                                {{ conteudo.tipo.replace('_', ' + ') | upper }}
                            </span>
                        </div>
                        <h5 class="card-title">{{ conteudo.titulo }}</h5>
                        
                      <p class="card-text">{{ conteudo.descricao }}</p>
                        
                        <div class="d-flex align-items-center mt-0 gap-2">

                            <button type="button" class="btn btn-like like-button" data-id="{{ conteudo.id_conteudo }}">
                                <i class="fas fa-heart me-1"></i> 
                                <span id="count-{{ conteudo.id_conteudo }}">{{ conteudo.contagem_likes }}</span>
                            </button>
                            
                            <button type="button" class="btn btn-view" data-bs-toggle="modal" data-bs-target="#conteudoModal" data-id="{{ conteudo.id_conteudo }}">
                                <i class="fas fa-eye me-1"></i> Ver
                            </button>
                            
                            <a href="{{ url_for('criar_post_mural', id_conteudo=conteudo.id_conteudo) }}" class="btn btn-rate">
                                <i class="fas fa-star me-1"></i> Avaliar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12">
                <p class="text-center text-white-50">Nenhum conteúdo disponível ainda. Volte em breve!</p>
            </div>
            {% endfor %}
        </div>
    </div>
<!-- Coluna Lateral: Os Mais Populares -->
<div class="col-lg-4 order-lg-2">
    <div class="card-sidebar">
        <div class="card-header">
            <h4><i class="fas fa-trophy me-2 text-warning"></i> Os Mais Populares</h4>
        </div>
        <div class="card-body p-0">
            {% if conteudos_populares %}
                <div class="popular-list">
                    <ul class="list-group list-group-flush">
                        {% for conteudo in conteudos_populares %}
                            <li class="list-group-item d-flex justify-content-between align-items-center border-0 p-3 popular-item">
                                <div class="d-flex align-items-center">
                                    <span class="badge rank-badge bg-primary me-3">#{{ loop.index }}</span>
                                    <span class="text-white small">{{ conteudo.titulo }}</span>
                                </div>
                                <span class="badge badge-likes">
                                    <i class="fas fa-heart me-1"></i> {{ conteudo.contagem_likes }}
                                </span>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <p class="text-white-75 text-center my-3">Nenhum conteúdo popular ainda.</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="conteudoModal" tabindex="-1" aria-labelledby="conteudoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-content-custom">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title text-white" id="conteudoModalLabel">Carregando...</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body modal-body-custom">
                <div id="modal-expand-link" class="text-end mb-2" style="font-size: 0.9rem;"></div>
                
                <div id="modal-content-area" class="mb-3"></div>
                <p id="modalDescricao" class="text-white-75"></p>
                <p><strong>Fonte:</strong> <span id="modalFonte" class="text-white-50"></span></p>
                
                <div class="d-flex justify-content-center gap-3 mt-4">
                    <div id="modal-main-link"></div>
                    <div id="modal-recurso-adicional"></div>
                </div>
                <div id="modal-external-link" class="text-center mt-4"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const conteudoModal = document.getElementById('conteudoModal');
    const contentArea = document.getElementById('modal-content-area');

    conteudoModal.addEventListener('hidden.bs.modal', function () {
        contentArea.innerHTML = '';
        document.getElementById('conteudoModalLabel').innerText = 'Carregando...';
        document.getElementById('modalDescricao').innerText = '';
        document.getElementById('modalFonte').innerText = '';
        document.getElementById('modal-recurso-adicional').innerHTML = '';
        document.getElementById('modal-external-link').innerHTML = '';
    });

    // VOTAÇÃO COM DESFAZER + BRILHO AMARELO
    const likeButtons = document.querySelectorAll('.like-button');

    likeButtons.forEach(button => {
        const conteudoId = button.getAttribute('data-id');
        const countElement = document.getElementById(`count-${conteudoId}`);

        // Função para atualizar o visual do botão de like
        function updateLikeButtonVisual(isVoted) {
             const icon = button.querySelector('i');
            if (isVoted) {
                button.classList.add('voted');
                button.style.backgroundColor = 'rgba(255, 107, 107, 0.4)';
                icon.style.color = '#ff6b6b';
            } else {
                button.classList.remove('voted');
                button.style.backgroundColor = 'rgba(255, 107, 107, 0.2)';
                icon.style.color = 'white';
            }
        }

        // Inicializa o estado visual (Você deve adicionar a classe 'voted' no HTML se o usuário já votou)
        updateLikeButtonVisual(button.classList.contains('voted'));


       button.addEventListener('click', async function() {
    if (button.disabled) return;

    button.disabled = true;

    try {
        const response = await fetch(`/api/conteudo/${conteudoId}/votar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }, // ✅ Adicionei a vírgula aqui
            credentials: 'include' // ✅ Agora vai funcionar
        });

        const data = await response.json();

        if (response.ok) {
            const isVoted = button.classList.contains('voted');
            
            // Toggle: se já estava votado, desfaz; senão, vota
            if (isVoted) {
                updateLikeButtonVisual(false);
                countElement.textContent = parseInt(countElement.textContent) - 1;
            } else {
                updateLikeButtonVisual(true);
                countElement.textContent = parseInt(countElement.textContent) + 1;
                
                // Brilho amarelo por 1 segundo (Efeito de Sucesso)
                button.style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.7)';
                setTimeout(() => {
                    button.style.boxShadow = 'none';
                }, 1000);
            }

            // Feedback visual suave
            button.style.transform = 'scale(1.2)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 300);

        } else if (response.status === 401) {
            alert('Você precisa fazer login para votar.');
            // Garante que o estado visual permaneça inalterado em caso de erro 401
        } else {
            alert('Erro ao processar o voto. Tente novamente.');
        }

    } catch (error) {
        console.error('Erro de conexão ao votar:', error);
        alert('Erro de conexão. Tente novamente mais tarde.');
    } finally {
        button.disabled = false;
    }
});
    });
});
</script>

{% endblock %}